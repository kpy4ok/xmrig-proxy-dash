<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mining Proxy Dashboard</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }
    .animate-spin {
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;
    const { Server, Users, RefreshCw } = lucide;

    const Dashboard = () => {
      const [proxyInfo, setProxyInfo] = useState(null);
      const [workersInfo, setWorkersInfo] = useState(null);
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState(null);
      const [config, setConfig] = useState({
        apiUrl: 'http://localhost:8080',
        accessToken: '',
        autoRefresh: true,
        refreshInterval: 30
      });
      
      const fetchData = async () => {
        setLoading(true);
        try {
          const headers = {};
          if (config.accessToken) {
            headers['Authorization'] = `Bearer ${config.accessToken}`;
          }
          
          // Fetch proxy info
          const proxyResponse = await fetch(`${config.apiUrl}/`, {
            headers,
            // Add mode: 'cors' for cross-origin requests
            mode: 'cors'
          });
          
          if (!proxyResponse.ok) {
            throw new Error(`Error fetching proxy data: ${proxyResponse.status}`);
          }
          
          const proxyData = await proxyResponse.json();
          setProxyInfo(proxyData);
          
          // Fetch workers info
          const workersResponse = await fetch(`${config.apiUrl}/workers.json`, {
            headers,
            mode: 'cors'
          });
          
          if (!workersResponse.ok) {
            throw new Error(`Error fetching workers data: ${workersResponse.status}`);
          }
          
          const workersData = await workersResponse.json();
          setWorkersInfo(workersData);
          
          setError(null);
        } catch (err) {
          console.error('Failed to fetch data:', err);
          setError(err.message);
        } finally {
          setLoading(false);
        }
      };
      
      useEffect(() => {
        // Initial fetch
        fetchData();
        
        // Set up auto refresh
        let interval;
        if (config.autoRefresh) {
          interval = setInterval(fetchData, config.refreshInterval * 1000);
        }
        
        return () => {
          if (interval) {
            clearInterval(interval);
          }
        };
      }, [config.apiUrl, config.accessToken, config.autoRefresh, config.refreshInterval]);
      
      const formatHashrate = (hashrate) => {
        if (!hashrate || isNaN(hashrate)) return '0.00 H/s';
        
        if (hashrate >= 1000000) {
          return `${(hashrate / 1000000).toFixed(2)} MH/s`;
        } else if (hashrate >= 1000) {
          return `${(hashrate / 1000).toFixed(2)} KH/s`;
        } else {
          return `${hashrate.toFixed(2)} H/s`;
        }
      };
      
      const formatTimespan = (seconds) => {
        if (!seconds || isNaN(seconds)) return '0s';
        
        const days = Math.floor(seconds / 86400);
        const hours = Math.floor((seconds % 86400) / 3600);
        const minutes = Math.floor((seconds % 3600) / 60);
        const remainingSeconds = seconds % 60;
        
        if (days > 0) {
          return `${days}d ${hours}h ${minutes}m`;
        } else if (hours > 0) {
          return `${hours}h ${minutes}m ${remainingSeconds}s`;
        } else if (minutes > 0) {
          return `${minutes}m ${remainingSeconds}s`;
        } else {
          return `${remainingSeconds}s`;
        }
      };
      
      const getLastSeen = (timestamp) => {
        if (!timestamp) return 'N/A';
        
        const now = Date.now();
        const diff = Math.floor((now - timestamp) / 1000);
        
        return formatTimespan(diff) + ' ago';
      };
      
      return (
        <div className="flex flex-col min-h-screen bg-gray-100">
          <header className="bg-gray-800 text-white p-4 shadow-md">
            <div className="container mx-auto flex justify-between items-center">
              <h1 className="text-xl font-bold">Mining Proxy Dashboard</h1>
              <div className="flex items-center space-x-4">
                <button 
                  onClick={fetchData} 
                  className="flex items-center px-3 py-1 bg-blue-600 rounded hover:bg-blue-700 transition"
                  disabled={loading}
                >
                  <RefreshCw size={16} className="mr-2" />
                  Refresh
                </button>
              </div>
            </div>
          </header>
          
          <div className="container mx-auto p-4 flex-grow">
            <div className="flex flex-col lg:flex-row gap-4 mb-4">
              <div className="w-full lg:w-1/3 p-4 bg-white rounded shadow">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-lg font-semibold">Connection Settings</h2>
                </div>
                
                <div className="space-y-3">
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">API URL</label>
                    <input 
                      type="text" 
                      value={config.apiUrl} 
                      onChange={(e) => setConfig({...config, apiUrl: e.target.value})}
                      className="w-full px-3 py-2 border rounded"
                      placeholder="http://localhost:8080"
                    />
                  </div>
                  
                  <div>
                    <label className="block text-sm text-gray-600 mb-1">Access Token (optional)</label>
                    <input 
                      type="password" 
                      value={config.accessToken} 
                      onChange={(e) => setConfig({...config, accessToken: e.target.value})}
                      className="w-full px-3 py-2 border rounded"
                      placeholder="Bearer token"
                    />
                  </div>
                  
                  <div className="flex items-center">
                    <input 
                      type="checkbox" 
                      id="autoRefresh" 
                      checked={config.autoRefresh}
                      onChange={(e) => setConfig({...config, autoRefresh: e.target.checked})}
                      className="mr-2"
                    />
                    <label htmlFor="autoRefresh" className="text-sm text-gray-600">Auto refresh</label>
                    
                    {config.autoRefresh && (
                      <div className="ml-4">
                        <select 
                          value={config.refreshInterval}
                          onChange={(e) => setConfig({...config, refreshInterval: parseInt(e.target.value)})}
                          className="px-2 py-1 border rounded"
                        >
                          <option value="10">10 sec</option>
                          <option value="30">30 sec</option>
                          <option value="60">1 min</option>
                          <option value="300">5 min</option>
                        </select>
                      </div>
                    )}
                  </div>
                  
                  <div>
                    <button 
                      onClick={fetchData}
                      className="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
                      disabled={loading}
                    >
                      {loading ? 'Loading...' : 'Connect'}
                    </button>
                  </div>
                </div>
              </div>
              
              {error ? (
                <div className="w-full lg:w-2/3 p-4 bg-red-100 text-red-800 rounded shadow">
                  <h2 className="text-lg font-semibold mb-2">Connection Error</h2>
                  <p>{error}</p>
                  <p className="mt-2 text-sm">Please check your connection settings and try again.</p>
                </div>
              ) : proxyInfo ? (
                <div className="w-full lg:w-2/3 grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div className="p-4 bg-white rounded shadow">
                    <h2 className="text-lg font-semibold mb-4">Proxy Info</h2>
                    <div className="space-y-2">
                      <div className="flex justify-between">
                        <span className="text-gray-600">ID:</span>
                        <span className="font-mono">{proxyInfo.id}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Worker ID:</span>
                        <span>{proxyInfo.worker_id}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Version:</span>
                        <span>{proxyInfo.version}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Uptime:</span>
                        <span>{formatTimespan(proxyInfo.uptime)}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Miners:</span>
                        <span>{proxyInfo.miners.now} / {proxyInfo.miners.max}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Upstreams:</span>
                        <span>{proxyInfo.upstreams}</span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="p-4 bg-white rounded shadow">
                    <h2 className="text-lg font-semibold mb-4">Results</h2>
                    <div className="space-y-2">
                      <div className="flex justify-between">
                        <span className="text-gray-600">Accepted:</span>
                        <span className="text-green-600">{proxyInfo.results.accepted}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Rejected:</span>
                        <span className="text-red-600">{proxyInfo.results.rejected}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Invalid:</span>
                        <span className="text-red-600">{proxyInfo.results.invalid}</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Avg Time:</span>
                        <span>{proxyInfo.results.avg_time} ms</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Latency:</span>
                        <span>{proxyInfo.results.latency} ms</span>
                      </div>
                      <div className="flex justify-between">
                        <span className="text-gray-600">Total Hashes:</span>
                        <span>{proxyInfo.results.hashes_total.toLocaleString()}</span>
                      </div>
                    </div>
                  </div>
                  
                  <div className="p-4 bg-white rounded shadow md:col-span-2">
                    <h2 className="text-lg font-semibold mb-4">Hashrate</h2>
                    <div className="grid grid-cols-5 gap-2">
                      <div className="text-center p-2 bg-gray-100 rounded">
                        <div className="text-sm text-gray-600">1 min</div>
                        <div className="font-semibold">{formatHashrate(proxyInfo.hashrate.total[0])}</div>
                      </div>
                      <div className="text-center p-2 bg-gray-100 rounded">
                        <div className="text-sm text-gray-600">10 min</div>
                        <div className="font-semibold">{formatHashrate(proxyInfo.hashrate.total[1])}</div>
                      </div>
                      <div className="text-center p-2 bg-gray-100 rounded">
                        <div className="text-sm text-gray-600">1 hour</div>
                        <div className="font-semibold">{formatHashrate(proxyInfo.hashrate.total[2])}</div>
                      </div>
                      <div className="text-center p-2 bg-gray-100 rounded">
                        <div className="text-sm text-gray-600">12 hours</div>
                        <div className="font-semibold">{formatHashrate(proxyInfo.hashrate.total[3])}</div>
                      </div>
                      <div className="text-center p-2 bg-gray-100 rounded">
                        <div className="text-sm text-gray-600">24 hours</div>
                        <div className="font-semibold">{formatHashrate(proxyInfo.hashrate.total[4])}</div>
                      </div>
                    </div>
                  </div>
                </div>
              ) : (
                <div className="w-full lg:w-2/3 flex items-center justify-center p-8 bg-white rounded shadow">
                  {loading ? (
                    <div className="text-center">
                      <div className="inline-block animate-spin h-8 w-8 border-4 border-blue-600 border-t-transparent rounded-full mb-2"></div>
                      <p>Loading proxy data...</p>
                    </div>
                  ) : (
                    <div className="text-center text-gray-500">
                      <Server size={48} className="mx-auto mb-2" />
                      <p>Enter connection details and click Connect to view proxy statistics</p>
                    </div>
                  )}
                </div>
              )}
            </div>
            
            {workersInfo && (
              <div className="bg-white rounded shadow">
                <div className="p-4 border-b">
                  <h2 className="text-lg font-semibold">Workers</h2>
                </div>
                
                {workersInfo.workers && workersInfo.workers.length > 0 ? (
                  <div className="overflow-x-auto">
                    <table className="w-full">
                      <thead>
                        <tr className="bg-gray-100">
                          <th className="py-2 px-4 text-left">Name</th>
                          <th className="py-2 px-4 text-left">IP Address</th>
                          <th className="py-2 px-4 text-center">Connections</th>
                          <th className="py-2 px-4 text-center">Accepted</th>
                          <th className="py-2 px-4 text-center">Rejected</th>
                          <th className="py-2 px-4 text-center">Invalid</th>
                          <th className="py-2 px-4 text-right">Total Hashes</th>
                          <th className="py-2 px-4 text-right">Last Seen</th>
                          <th className="py-2 px-4 text-right">Hashrate (1m)</th>
                        </tr>
                      </thead>
                      <tbody>
                        {workersInfo.workers.map((worker, index) => (
                          <tr key={index} className="border-t hover:bg-gray-50">
                            <td className="py-3 px-4">{worker[0]}</td>
                            <td className="py-3 px-4 font-mono text-sm">{worker[1]}</td>
                            <td className="py-3 px-4 text-center">{worker[2]}</td>
                            <td className="py-3 px-4 text-center text-green-600">{worker[3]}</td>
                            <td className="py-3 px-4 text-center text-red-600">{worker[4]}</td>
                            <td className="py-3 px-4 text-center text-red-600">{worker[5]}</td>
                            <td className="py-3 px-4 text-right">{worker[6].toLocaleString()}</td>
                            <td className="py-3 px-4 text-right">{getLastSeen(worker[7])}</td>
                            <td className="py-3 px-4 text-right font-semibold">{formatHashrate(worker[8])}</td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                ) : (
                  <div className="p-8 text-center text-gray-500">
                    <Users size={48} className="mx-auto mb-2" />
                    <p>No workers connected</p>
                  </div>
                )}
              </div>
            )}
          </div>
          
          <footer className="bg-gray-800 text-gray-400 p-4 text-center text-sm">
            <p>Mining Proxy Dashboard • Connected to {config.apiUrl}</p>
          </footer>
        </div>
      );
    };

    ReactDOM.render(<Dashboard />, document.getElementById('root'));
  </script>
</body>
</html>
